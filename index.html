<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalanche & Weather Dashboard - Southern AB / BC Interior</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="dark-mode">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Avalanche Canada region IDs mapping
        const AVALANCHE_CANADA_REGIONS = {
            'banff': 'banff-yoho-kootenay',
            'kananaskis': 'kananaskis',
            'lake-louise': 'banff-yoho-kootenay',
            'south-rockies': 'south-rockies',
            'south-columbia': 'south-columbia',
            'glacier': 'glacier'
        };

        // Weather Trend Chart Component
        function WeatherTrendChart({ data, darkMode }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !data) return;

                // Destroy existing chart
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const ctx = chartRef.current.getContext('2d');

                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Temperature (¬∞C)',
                                data: data.temperature,
                                borderColor: '#FF6384',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                yAxisID: 'y',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Snowfall (cm)',
                                data: data.snowfall,
                                borderColor: '#36A2EB',
                                backgroundColor: 'rgba(54, 162, 235, 0.3)',
                                yAxisID: 'y1',
                                type: 'bar'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: darkMode ? '#e0e0e0' : '#333'
                                }
                            },
                            title: {
                                display: true,
                                text: '7-Day Weather Trend',
                                color: darkMode ? '#6eb5ff' : '#1e3c72',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: darkMode ? '#aaa' : '#666' },
                                grid: { color: darkMode ? '#333' : '#eee' }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (¬∞C)',
                                    color: darkMode ? '#aaa' : '#666'
                                },
                                ticks: { color: darkMode ? '#aaa' : '#666' },
                                grid: { color: darkMode ? '#333' : '#eee' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Snowfall (cm)',
                                    color: darkMode ? '#aaa' : '#666'
                                },
                                ticks: { color: darkMode ? '#aaa' : '#666' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, darkMode]);

            return (
                <div style={{ height: '300px', position: 'relative' }}>
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        }

        // Wind Chart Component
        function WindChart({ data, darkMode }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !data) return;

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const ctx = chartRef.current.getContext('2d');

                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Wind Speed (km/h)',
                                data: data.windSpeed,
                                borderColor: '#4BC0C0',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Wind Gusts (km/h)',
                                data: data.windGusts,
                                borderColor: '#FF9F40',
                                backgroundColor: 'rgba(255, 159, 64, 0.1)',
                                tension: 0.3,
                                borderDash: [5, 5],
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: darkMode ? '#e0e0e0' : '#333' }
                            },
                            title: {
                                display: true,
                                text: '48-Hour Wind Forecast',
                                color: darkMode ? '#6eb5ff' : '#1e3c72',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: darkMode ? '#aaa' : '#666' },
                                grid: { color: darkMode ? '#333' : '#eee' }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Wind Speed (km/h)',
                                    color: darkMode ? '#aaa' : '#666'
                                },
                                ticks: { color: darkMode ? '#aaa' : '#666' },
                                grid: { color: darkMode ? '#333' : '#eee' }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, darkMode]);

            return (
                <div style={{ height: '250px', position: 'relative' }}>
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        }

        // Helper function to convert wind degrees to direction
        function getWindDirection(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
                                'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // Regional data with coordinates and image placeholders
        const REGIONS = [
            { 
                id: 'banff', 
                name: 'Banff National Park', 
                center: 'Parks Canada',
                lat: 51.4968,
                lng: -115.9281,
                zoom: 10,
                imageUrl: 'https://images.unsplash.com/photo-1605640840605-14ac1855827b?w=800&auto=format&fit=crop', // Banff mountains
                description: 'Classic Canadian Rockies terrain with iconic peaks and glacier-fed valleys'
            },
            { 
                id: 'kananaskis', 
                name: 'Kananaskis Country', 
                center: 'Avalanche Canada',
                lat: 50.7167,
                lng: -115.0833,
                zoom: 10,
                imageUrl: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&auto=format&fit=crop', // Mountain landscape
                description: 'Diverse alpine and subalpine terrain south of Banff'
            },
            { 
                id: 'lake-louise', 
                name: 'Lake Louise', 
                center: 'Parks Canada',
                lat: 51.4254,
                lng: -116.1773,
                zoom: 11,
                imageUrl: 'https://images.unsplash.com/photo-1503614472-8c93d56e92ce?w=800&auto=format&fit=crop', // Lake Louise area
                description: 'High alpine terrain with extensive backcountry skiing options'
            },
            { 
                id: 'south-rockies', 
                name: 'South Rockies', 
                center: 'Avalanche Canada',
                lat: 49.5833,
                lng: -114.7500,
                zoom: 9,
                imageUrl: 'https://images.unsplash.com/photo-1519904981063-b0cf448d479e?w=800&auto=format&fit=crop', // Rocky mountains
                description: 'Southern Alberta Rockies including Crowsnest Pass area'
            },
            { 
                id: 'south-columbia', 
                name: 'South Columbia', 
                center: 'Avalanche Canada',
                lat: 51.2500,
                lng: -117.5000,
                zoom: 9,
                imageUrl: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&auto=format&fit=crop', // Columbia mountains
                description: 'Interior BC ranges with deep continental snowpack'
            },
            { 
                id: 'glacier', 
                name: 'Glacier National Park', 
                center: 'Parks Canada',
                lat: 51.2667,
                lng: -117.5167,
                zoom: 10,
                imageUrl: 'https://images.unsplash.com/photo-1486870591958-9b9d0d1dda99?w=800&auto=format&fit=crop', // Glacier terrain
                description: 'Rogers Pass area with heavy snowfall and complex avalanche terrain'
            },
        ];

        // SpotWX-style weather stations (sample data - would connect to real SpotWX API)
        const SPOTWX_STATIONS = [
            { 
                id: 'banff-upper', 
                name: 'Banff Upper Station',
                elevation: '2240m',
                region: 'banff',
                lat: 51.4968,
                lng: -115.9281,
                data: {
                    temp: -8.2,
                    dewpoint: -12.5,
                    humidity: 72,
                    windSpeed: 45,
                    windGust: 62,
                    windDir: 'SW',
                    pressure: 775,
                    snowDepth: 142,
                    snow24h: 12,
                    snow48h: 28,
                    swe: 45
                }
            },
            { 
                id: 'sunshine-village', 
                name: 'Sunshine Village',
                elevation: '2100m',
                region: 'banff',
                lat: 51.1167,
                lng: -115.7667,
                data: {
                    temp: -6.5,
                    dewpoint: -10.2,
                    humidity: 78,
                    windSpeed: 38,
                    windGust: 55,
                    windDir: 'WSW',
                    pressure: 780,
                    snowDepth: 156,
                    snow24h: 15,
                    snow48h: 32,
                    swe: 52
                }
            },
            { 
                id: 'lake-louise-upper', 
                name: 'Lake Louise Alpine',
                elevation: '2637m',
                region: 'lake-louise',
                lat: 51.4254,
                lng: -116.1773,
                data: {
                    temp: -10.1,
                    dewpoint: -14.8,
                    humidity: 68,
                    windSpeed: 52,
                    windGust: 78,
                    windDir: 'SW',
                    pressure: 742,
                    snowDepth: 168,
                    snow24h: 18,
                    snow48h: 35,
                    swe: 58
                }
            },
            {
                id: 'castle-mtn',
                name: 'Castle Mountain',
                elevation: '1850m',
                region: 'kananaskis',
                lat: 51.2667,
                lng: -115.4500,
                data: {
                    temp: -5.3,
                    dewpoint: -8.9,
                    humidity: 80,
                    windSpeed: 28,
                    windGust: 42,
                    windDir: 'W',
                    pressure: 815,
                    snowDepth: 121,
                    snow24h: 10,
                    snow48h: 25,
                    swe: 38
                }
            },
            {
                id: 'crowsnest-pass',
                name: 'Crowsnest Pass',
                elevation: '1780m',
                region: 'south-rockies',
                lat: 49.6347,
                lng: -114.4142,
                data: {
                    temp: -4.8,
                    dewpoint: -9.1,
                    humidity: 71,
                    windSpeed: 35,
                    windGust: 58,
                    windDir: 'W',
                    pressure: 825,
                    snowDepth: 98,
                    snow24h: 8,
                    snow48h: 18,
                    swe: 32
                }
            },
            {
                id: 'castle-resort',
                name: 'Castle Mountain Resort',
                elevation: '2100m',
                region: 'south-rockies',
                lat: 49.3167,
                lng: -114.4000,
                data: {
                    temp: -7.2,
                    dewpoint: -11.5,
                    humidity: 74,
                    windSpeed: 42,
                    windGust: 65,
                    windDir: 'SW',
                    pressure: 785,
                    snowDepth: 135,
                    snow24h: 14,
                    snow48h: 28,
                    swe: 45
                }
            },
            {
                id: 'rogers-pass',
                name: 'Rogers Pass Summit',
                elevation: '1330m',
                region: 'glacier',
                lat: 51.3000,
                lng: -117.5200,
                data: {
                    temp: -3.5,
                    dewpoint: -6.2,
                    humidity: 82,
                    windSpeed: 25,
                    windGust: 45,
                    windDir: 'SW',
                    pressure: 865,
                    snowDepth: 210,
                    snow24h: 22,
                    snow48h: 45,
                    swe: 72
                }
            },
            {
                id: 'fidelity-mtn',
                name: 'Mt. Fidelity',
                elevation: '1875m',
                region: 'glacier',
                lat: 51.2333,
                lng: -117.4667,
                data: {
                    temp: -6.8,
                    dewpoint: -10.1,
                    humidity: 78,
                    windSpeed: 38,
                    windGust: 62,
                    windDir: 'W',
                    pressure: 810,
                    snowDepth: 245,
                    snow24h: 28,
                    snow48h: 52,
                    swe: 85
                }
            },
            {
                id: 'kootenay-pass',
                name: 'Kootenay Pass',
                elevation: '1775m',
                region: 'south-columbia',
                lat: 49.0833,
                lng: -117.0333,
                data: {
                    temp: -5.1,
                    dewpoint: -8.8,
                    humidity: 76,
                    windSpeed: 32,
                    windGust: 48,
                    windDir: 'SW',
                    pressure: 820,
                    snowDepth: 178,
                    snow24h: 16,
                    snow48h: 35,
                    swe: 58
                }
            }
        ];

        function AvalancheDashboard() {
            const [selectedRegion, setSelectedRegion] = useState('kananaskis');
            const [darkMode, setDarkMode] = useState(true);
            const [lastUpdate, setLastUpdate] = useState(new Date());
            const [loading, setLoading] = useState({ weather: false, avalanche: false });
            const [apiError, setApiError] = useState({ weather: null, avalanche: null });
            const [weatherTrendData, setWeatherTrendData] = useState(null);
            const [windChartData, setWindChartData] = useState(null);
            const [liveWeather, setLiveWeather] = useState(null);
            const [liveAvalanche, setLiveAvalanche] = useState(null);
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const [expandedIncident, setExpandedIncident] = useState(null);
            const [incidents, setIncidents] = useState([
                {
                    id: 1,
                    type: 'avalanche',
                    title: 'Natural Size 2.5 Avalanche',
                    location: 'Commonwealth Creek, Kananaskis',
                    date: '2024-12-12',
                    details: 'Natural avalanche observed on NE aspect at 2400m. Crown depth 80cm, ran 400m vertical. Wind slab on persistent weak layer.',
                    severity: 'moderate'
                },
                {
                    id: 2,
                    type: 'avalanche',
                    title: 'Skier-Triggered Size 1.5',
                    location: 'Goat Range, Lake Louise',
                    date: '2024-12-11',
                    details: 'Remotely triggered from ridgeline. Storm snow on sun crust. No one caught.',
                    severity: 'low'
                },
                {
                    id: 3,
                    type: 'weather',
                    title: 'High Wind Warning',
                    location: 'Southern Rockies - All Areas',
                    date: '2024-12-13',
                    details: 'SW winds 60-80 km/h with gusts to 100 km/h expected above treeline. Significant snow transport and loading on lee slopes.',
                    severity: 'high'
                },
                {
                    id: 4,
                    type: 'avalanche',
                    title: 'Cornice Fall with Sympathetic Trigger',
                    location: 'Mount Assiniboine Area',
                    date: '2024-12-10',
                    details: 'Large cornice fall triggered size 2 avalanche below. E aspect, 2600m elevation.',
                    severity: 'moderate'
                },
            ]);

            useEffect(() => {
                document.body.className = darkMode ? 'dark-mode' : 'light-mode';
            }, [darkMode]);

            // Fetch weather data from Open-Meteo API
            const fetchWeatherData = useCallback(async (region) => {
                setLoading(prev => ({ ...prev, weather: true }));
                setApiError(prev => ({ ...prev, weather: null }));

                try {
                    const regionData = REGIONS.find(r => r.id === region);
                    if (!regionData) return;

                    // Open-Meteo API - free, no key required
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?` +
                        `latitude=${regionData.lat}&longitude=${regionData.lng}` +
                        `&hourly=temperature_2m,snowfall,wind_speed_10m,wind_gusts_10m,precipitation` +
                        `&daily=temperature_2m_max,temperature_2m_min,snowfall_sum,precipitation_sum,wind_speed_10m_max,wind_gusts_10m_max` +
                        `&current=temperature_2m,wind_speed_10m,wind_direction_10m,wind_gusts_10m` +
                        `&timezone=America/Edmonton&forecast_days=7`
                    );

                    if (!response.ok) throw new Error('Weather API request failed');

                    const data = await response.json();

                    // Process current weather
                    setLiveWeather({
                        temp: Math.round(data.current.temperature_2m),
                        windSpeed: Math.round(data.current.wind_speed_10m),
                        windGusts: Math.round(data.current.wind_gusts_10m),
                        windDirection: getWindDirection(data.current.wind_direction_10m),
                        // Calculate 24h and 48h snowfall from hourly data
                        snow24h: Math.round(data.hourly.snowfall.slice(0, 24).reduce((a, b) => a + b, 0) * 10) / 10,
                        snow48h: Math.round(data.hourly.snowfall.slice(0, 48).reduce((a, b) => a + b, 0) * 10) / 10
                    });

                    // Process 7-day trend data for chart
                    const dailyLabels = data.daily.time.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    });

                    setWeatherTrendData({
                        labels: dailyLabels,
                        temperature: data.daily.temperature_2m_max.map((max, i) =>
                            Math.round((max + data.daily.temperature_2m_min[i]) / 2)
                        ),
                        snowfall: data.daily.snowfall_sum.map(s => Math.round(s * 10) / 10)
                    });

                    // Process 48-hour wind data for chart
                    const hourlyLabels = data.hourly.time.slice(0, 48).map((time, i) => {
                        if (i % 6 === 0) {
                            const d = new Date(time);
                            return d.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                        }
                        return '';
                    });

                    setWindChartData({
                        labels: hourlyLabels,
                        windSpeed: data.hourly.wind_speed_10m.slice(0, 48),
                        windGusts: data.hourly.wind_gusts_10m.slice(0, 48)
                    });

                    setLastUpdate(new Date());
                } catch (error) {
                    console.error('Weather API error:', error);
                    setApiError(prev => ({ ...prev, weather: error.message }));
                } finally {
                    setLoading(prev => ({ ...prev, weather: false }));
                }
            }, []);

            // Fetch avalanche forecast from Avalanche Canada API
            const fetchAvalancheData = useCallback(async (region) => {
                setLoading(prev => ({ ...prev, avalanche: true }));
                setApiError(prev => ({ ...prev, avalanche: null }));

                try {
                    const avCanRegion = AVALANCHE_CANADA_REGIONS[region];
                    if (!avCanRegion) {
                        throw new Error('Region not mapped to Avalanche Canada');
                    }

                    // Avalanche Canada public API
                    const response = await fetch(
                        `https://api.avalanche.ca/forecasts/en/products/point?lat=${REGIONS.find(r => r.id === region).lat}&long=${REGIONS.find(r => r.id === region).lng}`
                    );

                    if (!response.ok) throw new Error('Avalanche API request failed');

                    const data = await response.json();

                    if (data && data.report) {
                        const report = data.report;

                        // Helper to extract rating value (handles both number and {value, display} objects)
                        const getRatingValue = (rating) => {
                            if (rating === null || rating === undefined) return 0;
                            if (typeof rating === 'number') return rating;
                            if (typeof rating === 'object' && rating.value !== undefined) return rating.value;
                            return 0;
                        };

                        // Parse danger ratings
                        const dangerRatings = report.dangerRatings || [];
                        const todayRatings = dangerRatings.find(d => d.date?.display === 'Today') || dangerRatings[0] || {};

                        // Extract ratings safely
                        const alpRating = todayRatings.ratings?.alp?.rating;
                        const tlnRating = todayRatings.ratings?.tln?.rating;
                        const btlRating = todayRatings.ratings?.btl?.rating;

                        // Parse avalanche problems
                        const problems = (report.problems || []).map(p => {
                            // Handle likelihood which might be an object
                            let likelihood = p.likelihood;
                            if (typeof likelihood === 'object' && likelihood !== null) {
                                likelihood = likelihood.display || likelihood.value || 'Unknown';
                            }

                            // Handle type which might be an object
                            let problemType = p.type;
                            if (typeof problemType === 'object' && problemType !== null) {
                                problemType = problemType.display || problemType.value || 'Unknown';
                            }

                            return {
                                type: problemType || 'Unknown',
                                likelihood: likelihood || 'Unknown',
                                size: p.expectedSize ? `${p.expectedSize.min || '?'}-${p.expectedSize.max || '?'}` : 'Unknown',
                                aspects: p.aspects || [],
                                elevations: p.elevations || []
                            };
                        });

                        // Handle summary which might be HTML or an object
                        let summary = report.highlights || report.summary || 'No summary available.';
                        if (typeof summary === 'object') {
                            summary = summary.display || summary.value || JSON.stringify(summary);
                        }

                        setLiveAvalanche({
                            date: report.dateIssued ? new Date(report.dateIssued).toLocaleDateString() : new Date().toLocaleDateString(),
                            validUntil: report.validUntil ? new Date(report.validUntil).toLocaleDateString() : null,
                            ratings: {
                                alpine: getRatingValue(alpRating),
                                treeline: getRatingValue(tlnRating),
                                belowTreeline: getRatingValue(btlRating)
                            },
                            problems: problems.slice(0, 4),
                            summary: summary,
                            confidence: report.confidence || null,
                            forecaster: report.forecaster || null
                        });
                    }
                } catch (error) {
                    console.error('Avalanche API error:', error);
                    setApiError(prev => ({ ...prev, avalanche: error.message }));
                    // Keep using fallback data on error
                } finally {
                    setLoading(prev => ({ ...prev, avalanche: false }));
                }
            }, []);

            // Fetch data when region changes
            useEffect(() => {
                fetchWeatherData(selectedRegion);
                fetchAvalancheData(selectedRegion);
            }, [selectedRegion, fetchWeatherData, fetchAvalancheData]);

            // Refresh data function
            const refreshData = () => {
                fetchWeatherData(selectedRegion);
                fetchAvalancheData(selectedRegion);
            };

            // Initialize map when region changes
            useEffect(() => {
                if (mapRef.current && !mapInstanceRef.current) {
                    const region = REGIONS.find(r => r.id === selectedRegion);
                    mapInstanceRef.current = L.map(mapRef.current).setView([region.lat, region.lng], region.zoom);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(mapInstanceRef.current);

                    // Add markers for weather stations in this region
                    const regionStations = SPOTWX_STATIONS.filter(s => s.region === selectedRegion);
                    regionStations.forEach(station => {
                        L.marker([station.lat, station.lng])
                            .bindPopup(`<b>${station.name}</b><br>${station.elevation}<br>Temp: ${station.data.temp}¬∞C<br>Wind: ${station.data.windSpeed} km/h ${station.data.windDir}`)
                            .addTo(mapInstanceRef.current);
                    });
                } else if (mapInstanceRef.current) {
                    const region = REGIONS.find(r => r.id === selectedRegion);
                    mapInstanceRef.current.setView([region.lat, region.lng], region.zoom);
                    
                    // Clear existing markers and add new ones
                    mapInstanceRef.current.eachLayer((layer) => {
                        if (layer instanceof L.Marker) {
                            mapInstanceRef.current.removeLayer(layer);
                        }
                    });

                    const regionStations = SPOTWX_STATIONS.filter(s => s.region === selectedRegion);
                    regionStations.forEach(station => {
                        L.marker([station.lat, station.lng])
                            .bindPopup(`<b>${station.name}</b><br>${station.elevation}<br>Temp: ${station.data.temp}¬∞C<br>Wind: ${station.data.windSpeed} km/h ${station.data.windDir}`)
                            .addTo(mapInstanceRef.current);
                    });
                }
            }, [selectedRegion]);

            const currentRegion = REGIONS.find(r => r.id === selectedRegion);
            const regionStations = SPOTWX_STATIONS.filter(s => s.region === selectedRegion);

            const avalancheForecast = {
                date: '2024-12-13',
                ratings: {
                    alpine: 3,
                    treeline: 3,
                    belowTreeline: 2
                },
                trend: 'Increasing',
                problems: [
                    { type: 'Wind Slab', likelihood: 'Likely', size: '1-2.5' },
                    { type: 'Persistent Slab', likelihood: 'Possible', size: '2-3' },
                    { type: 'Storm Slab', likelihood: 'Possible', size: '1-2' }
                ],
                summary: 'Strong southwest winds continue to build fresh wind slabs on lee slopes. A persistent weak layer exists in mid-pack on shady aspects above 2200m. New snow loading increases stress on this layer. Conservative terrain selection recommended.'
            };

            const weatherData = {
                current: {
                    temp: -6,
                    windSpeed: 45,
                    windDirection: 'SW',
                    snowLast24h: 12,
                    snowLast48h: 28,
                    visibility: 'Poor'
                },
                forecast24h: {
                    snowfall: '15-25cm',
                    wind: 'SW 40-60 km/h, gusts 80',
                    temp: '-8 to -12¬∞C',
                    freezingLevel: '1400m'
                },
                extended: {
                    day2: { snow: '5-10cm', temp: '-10 to -15¬∞C', wind: 'W 30-40' },
                    day3: { snow: '0-2cm', temp: '-12 to -18¬∞C', wind: 'NW 20-30' },
                    day4: { snow: '10-20cm', temp: '-8 to -13¬∞C', wind: 'SW 35-50' }
                }
            };

            const getDangerColor = (level) => {
                const colors = ['#4CAF50', '#FFEB3B', '#FF9800', '#F44336', '#000'];
                return colors[level - 1] || '#ccc';
            };

            const getDangerLabel = (level) => {
                const labels = ['Low', 'Moderate', 'Considerable', 'High', 'Extreme'];
                return labels[level - 1] || 'Unknown';
            };

            return (
                <div className="dashboard">
                    <div className="header">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div>
                                <h1>üèîÔ∏è Avalanche & Weather Dashboard</h1>
                                <div className="subtitle">Southern Alberta & BC Interior Backcountry Monitoring</div>
                            </div>
                            <button 
                                className="dark-mode-toggle"
                                onClick={() => setDarkMode(!darkMode)}
                                aria-label="Toggle dark mode"
                            >
                                {darkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode'}
                            </button>
                        </div>
                        <div className="last-update">
                            Last updated: {lastUpdate.toLocaleString()}
                        </div>
                    </div>

                    {((liveAvalanche?.ratings?.alpine || avalancheForecast.ratings.alpine) >= 3) && (
                        <div className="alert-banner critical">
                            <strong>‚ö†Ô∏è CONSIDERABLE AVALANCHE DANGER</strong> - Alpine and treeline zones rated CONSIDERABLE ({liveAvalanche?.ratings?.alpine || avalancheForecast.ratings.alpine}).
                            Avalanches likely on wind-loaded slopes. Careful snowpack evaluation and conservative terrain selection essential.
                        </div>
                    )}

                    <div className="card">
                        <h2>üìç Select Region</h2>
                        <div className="region-selector">
                            {REGIONS.map(region => (
                                <button
                                    key={region.id}
                                    className={`region-btn ${selectedRegion === region.id ? 'active' : ''}`}
                                    onClick={() => setSelectedRegion(region.id)}
                                >
                                    {region.name}
                                </button>
                            ))}
                        </div>
                        <div className="data-source">
                            Forecast source: {currentRegion?.center}
                        </div>
                    </div>

                    {/* Map View */}
                    <div className="card">
                        <h2>üó∫Ô∏è Region Map & Weather Stations</h2>
                        <div ref={mapRef} className="map-container"></div>
                        <div className="data-source">
                            Interactive map showing weather station locations. Click markers for details.
                        </div>
                    </div>

                    <div className="grid">
                        <div className="card">
                            <h2>üéø Avalanche Forecast - {currentRegion?.name}</h2>
                            {loading.avalanche && <div className="loading">Loading avalanche forecast...</div>}
                            {apiError.avalanche && (
                                <div className="api-error" style={{background: darkMode ? '#3a2025' : '#f8d7da', padding: '10px', borderRadius: '8px', marginBottom: '15px', fontSize: '0.9em'}}>
                                    Using sample data - Live forecast temporarily unavailable
                                </div>
                            )}
                            {liveAvalanche && (
                                <div style={{background: darkMode ? '#1a3320' : '#d4edda', padding: '8px 12px', borderRadius: '6px', marginBottom: '10px', fontSize: '0.85em', color: darkMode ? '#90EE90' : '#155724'}}>
                                    LIVE from Avalanche Canada API
                                </div>
                            )}
                            <div style={{fontSize: '0.9em', color: darkMode ? '#aaa' : '#666', marginBottom: '10px'}}>
                                Valid: {(liveAvalanche?.date || avalancheForecast.date)}
                                {liveAvalanche?.validUntil && ` to ${liveAvalanche.validUntil}`}
                                {!liveAvalanche && ` | Trend: `}<strong>{!liveAvalanche && avalancheForecast.trend}</strong>
                            </div>

                            <h3>Danger Ratings by Elevation</h3>
                            <div className="elevation-bands">
                                <div className="elevation-band" style={{background: getDangerColor((liveAvalanche?.ratings?.alpine || avalancheForecast.ratings.alpine))}}>
                                    <div className="label" style={{color: (liveAvalanche?.ratings?.alpine || avalancheForecast.ratings.alpine) >= 3 ? 'white' : '#333'}}>
                                        Alpine (&gt;2200m)
                                    </div>
                                    <div style={{color: (liveAvalanche?.ratings?.alpine || avalancheForecast.ratings.alpine) >= 3 ? 'white' : '#333', fontSize: '1.2em', fontWeight: 'bold'}}>
                                        {(liveAvalanche?.ratings?.alpine || avalancheForecast.ratings.alpine)} - {getDangerLabel((liveAvalanche?.ratings?.alpine || avalancheForecast.ratings.alpine))}
                                    </div>
                                </div>
                                <div className="elevation-band" style={{background: getDangerColor((liveAvalanche?.ratings?.treeline || avalancheForecast.ratings.treeline))}}>
                                    <div className="label" style={{color: (liveAvalanche?.ratings?.treeline || avalancheForecast.ratings.treeline) >= 3 ? 'white' : '#333'}}>
                                        Treeline
                                    </div>
                                    <div style={{color: (liveAvalanche?.ratings?.treeline || avalancheForecast.ratings.treeline) >= 3 ? 'white' : '#333', fontSize: '1.2em', fontWeight: 'bold'}}>
                                        {(liveAvalanche?.ratings?.treeline || avalancheForecast.ratings.treeline)} - {getDangerLabel((liveAvalanche?.ratings?.treeline || avalancheForecast.ratings.treeline))}
                                    </div>
                                </div>
                                <div className="elevation-band" style={{background: getDangerColor((liveAvalanche?.ratings?.belowTreeline || avalancheForecast.ratings.belowTreeline))}}>
                                    <div className="label" style={{color: '#333'}}>Below Treeline</div>
                                    <div style={{color: '#333', fontSize: '1.2em', fontWeight: 'bold'}}>
                                        {(liveAvalanche?.ratings?.belowTreeline || avalancheForecast.ratings.belowTreeline)} - {getDangerLabel((liveAvalanche?.ratings?.belowTreeline || avalancheForecast.ratings.belowTreeline))}
                                    </div>
                                </div>
                            </div>

                            <h3>Avalanche Problems</h3>
                            <div>
                                {(liveAvalanche?.problems || avalancheForecast.problems).map((problem, idx) => (
                                    <div key={idx} style={{marginBottom: '10px'}}>
                                        <span className="problem-type">{problem.type}</span>
                                        <div style={{fontSize: '0.9em', marginTop: '5px', color: darkMode ? '#aaa' : '#666'}}>
                                            Likelihood: <strong>{problem.likelihood}</strong> | Size: <strong>{problem.size}</strong>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="forecast-summary">
                                <h4>Forecast Summary</h4>
                                <div
                                    style={{lineHeight: '1.6'}}
                                    dangerouslySetInnerHTML={{__html: liveAvalanche?.summary || avalancheForecast.summary}}
                                />
                            </div>

                            <div className="data-source">
                                Sources: Avalanche Canada API (avalanche.ca), Parks Canada Avalanche Forecasts
                            </div>
                        </div>

                        <div className="card">
                            <h2>üå°Ô∏è Current Weather Conditions</h2>
                            {loading.weather && <div className="loading">Loading weather data...</div>}
                            {apiError.weather && (
                                <div className="api-error" style={{background: darkMode ? '#3a2025' : '#f8d7da', padding: '10px', borderRadius: '8px', marginBottom: '15px', fontSize: '0.9em'}}>
                                    Using cached data - Live weather temporarily unavailable
                                </div>
                            )}
                            <div className="weather-grid">
                                <div className="weather-item">
                                    <div className="label">Temperature</div>
                                    <div className="value">
                                        {liveWeather?.temp ?? weatherData.current.temp}<span className="unit">¬∞C</span>
                                    </div>
                                    {liveWeather && <div style={{fontSize: '0.75em', color: '#4CAF50'}}>LIVE</div>}
                                </div>
                                <div className="weather-item">
                                    <div className="label">Wind</div>
                                    <div className="value">
                                        {liveWeather?.windSpeed ?? weatherData.current.windSpeed}<span className="unit">km/h</span>
                                    </div>
                                    <div style={{fontSize: '0.85em', color: darkMode ? '#aaa' : '#666'}}>
                                        {liveWeather?.windDirection ?? weatherData.current.windDirection}
                                        {liveWeather && ` (gusts ${liveWeather.windGusts})`}
                                    </div>
                                </div>
                                <div className="weather-item">
                                    <div className="label">Snow (24h)</div>
                                    <div className="value">
                                        {liveWeather?.snow24h ?? weatherData.current.snowLast24h}<span className="unit">cm</span>
                                    </div>
                                </div>
                                <div className="weather-item">
                                    <div className="label">Snow (48h)</div>
                                    <div className="value">
                                        {liveWeather?.snow48h ?? weatherData.current.snowLast48h}<span className="unit">cm</span>
                                    </div>
                                </div>
                            </div>

                            {/* Weather Trend Chart */}
                            {weatherTrendData && (
                                <div style={{marginTop: '20px'}}>
                                    <WeatherTrendChart data={weatherTrendData} darkMode={darkMode} />
                                </div>
                            )}

                            {/* Wind Chart */}
                            {windChartData && (
                                <div style={{marginTop: '20px'}}>
                                    <WindChart data={windChartData} darkMode={darkMode} />
                                </div>
                            )}

                            <div className="data-source">
                                Sources: Open-Meteo API (live data), Mountain-Forecast.com, Environment Canada
                            </div>
                        </div>
                    </div>

                    <div className="grid">
                        <div className="card">
                            <h2>üìä SpotWX Weather Stations - {currentRegion?.name}</h2>
                            <div className="station-list-detailed">
                                {regionStations.map(station => (
                                    <div key={station.id} className="station-card-detailed">
                                        <div className="station-header">
                                            <div>
                                                <div className="station-name">{station.name}</div>
                                                <div className="station-elevation">{station.elevation}</div>
                                            </div>
                                        </div>
                                        <div className="station-data-grid">
                                            <div className="data-item">
                                                <span className="data-label">Temperature</span>
                                                <span className="data-value">{station.data.temp}¬∞C</span>
                                            </div>
                                            <div className="data-item">
                                                <span className="data-label">Dewpoint</span>
                                                <span className="data-value">{station.data.dewpoint}¬∞C</span>
                                            </div>
                                            <div className="data-item">
                                                <span className="data-label">Humidity</span>
                                                <span className="data-value">{station.data.humidity}%</span>
                                            </div>
                                            <div className="data-item">
                                                <span className="data-label">Wind</span>
                                                <span className="data-value">{station.data.windSpeed} km/h {station.data.windDir}</span>
                                            </div>
                                            <div className="data-item">
                                                <span className="data-label">Gusts</span>
                                                <span className="data-value">{station.data.windGust} km/h</span>
                                            </div>
                                            <div className="data-item">
                                                <span className="data-label">Pressure</span>
                                                <span className="data-value">{station.data.pressure} mb</span>
                                            </div>
                                            <div className="data-item highlight">
                                                <span className="data-label">Snow Depth</span>
                                                <span className="data-value">{station.data.snowDepth} cm</span>
                                            </div>
                                            <div className="data-item highlight">
                                                <span className="data-label">24h Snow</span>
                                                <span className="data-value">{station.data.snow24h} cm</span>
                                            </div>
                                            <div className="data-item highlight">
                                                <span className="data-label">48h Snow</span>
                                                <span className="data-value">{station.data.snow48h} cm</span>
                                            </div>
                                            <div className="data-item highlight">
                                                <span className="data-label">SWE</span>
                                                <span className="data-value">{station.data.swe} mm</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="data-source">
                                Sources: SpotWX (spotwx.com), SNOTEL Network, Alberta Snow Survey, BC River Forecast Centre
                            </div>
                        </div>

                        <div className="card">
                            <h2>‚ö†Ô∏è Recent Incidents & Reports</h2>
                            <div className="incident-feed">
                                {incidents.map(incident => (
                                    <div
                                        key={incident.id}
                                        className={`incident ${incident.type !== 'avalanche' ? 'weather-incident' : ''} ${expandedIncident === incident.id ? 'expanded' : ''}`}
                                        onClick={() => setExpandedIncident(expandedIncident === incident.id ? null : incident.id)}
                                        style={{cursor: 'pointer'}}
                                    >
                                        <div className="incident-header">
                                            <div className="incident-title">
                                                {incident.type === 'avalanche' ? '‚ùÑÔ∏è' : 'üå™Ô∏è'} {incident.title}
                                            </div>
                                            <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                                <div className="incident-date">{incident.date}</div>
                                                <span style={{fontSize: '0.8em', color: darkMode ? '#6eb5ff' : '#2a5298'}}>
                                                    {expandedIncident === incident.id ? '‚ñº' : '‚ñ∂'}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="incident-location">üìç {incident.location}</div>

                                        {expandedIncident === incident.id ? (
                                            <div className="incident-expanded">
                                                <div className="incident-details" style={{marginBottom: '12px'}}>{incident.details}</div>
                                                <div style={{
                                                    display: 'grid',
                                                    gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
                                                    gap: '10px',
                                                    padding: '12px',
                                                    background: darkMode ? 'rgba(0,0,0,0.2)' : 'rgba(0,0,0,0.05)',
                                                    borderRadius: '8px',
                                                    marginTop: '10px'
                                                }}>
                                                    <div>
                                                        <div style={{fontSize: '0.75em', color: darkMode ? '#888' : '#666', textTransform: 'uppercase'}}>Type</div>
                                                        <div style={{fontWeight: '600', textTransform: 'capitalize'}}>{incident.type}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{fontSize: '0.75em', color: darkMode ? '#888' : '#666', textTransform: 'uppercase'}}>Severity</div>
                                                        <div style={{
                                                            fontWeight: '600',
                                                            textTransform: 'capitalize',
                                                            color: incident.severity === 'high' ? '#F44336' : incident.severity === 'moderate' ? '#FF9800' : '#4CAF50'
                                                        }}>{incident.severity}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{fontSize: '0.75em', color: darkMode ? '#888' : '#666', textTransform: 'uppercase'}}>Reported</div>
                                                        <div style={{fontWeight: '600'}}>{incident.date}</div>
                                                    </div>
                                                </div>
                                                {incident.type === 'avalanche' && (
                                                    <a
                                                        href="https://www.avalanche.ca/mountain-information-network"
                                                        target="_blank"
                                                        onClick={(e) => e.stopPropagation()}
                                                        style={{
                                                            display: 'inline-block',
                                                            marginTop: '12px',
                                                            padding: '8px 16px',
                                                            background: darkMode ? '#4a7cc7' : '#2a5298',
                                                            color: 'white',
                                                            borderRadius: '6px',
                                                            textDecoration: 'none',
                                                            fontSize: '0.85em',
                                                            fontWeight: '600'
                                                        }}
                                                    >
                                                        View on MIN ‚Üí
                                                    </a>
                                                )}
                                            </div>
                                        ) : (
                                            <div className="incident-details" style={{
                                                overflow: 'hidden',
                                                textOverflow: 'ellipsis',
                                                whiteSpace: 'nowrap',
                                                maxWidth: '100%'
                                            }}>
                                                {incident.details}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            <button className="refresh-btn" onClick={refreshData}>
                                üîÑ Refresh All Data
                            </button>
                            <div className="data-source">
                                Sources: Avalanche Canada MIN (Mountain Information Network), Parks Canada Public Avalanche Reports,
                                Environment Canada Weather Alerts
                            </div>
                        </div>
                    </div>

                    <div className="card">
                        <h2>üîó Additional Resources & Data Sources</h2>
                        <div style={{lineHeight: '2', fontSize: '0.95em'}}>
                            <strong>Avalanche Forecasts:</strong><br/>
                            ‚Ä¢ <a href="https://www.avalanche.ca" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>Avalanche Canada</a> - Regional forecasts for Kananaskis, South Rockies, South Columbia<br/>
                            ‚Ä¢ <a href="https://www.pc.gc.ca/en/pn-np/ab/banff/securite-safety/avalanche" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>Parks Canada</a> - Banff, Lake Louise, Glacier NP<br/>
                            ‚Ä¢ <a href="https://www.avalanche.ca/min" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>MIN Reports</a> - User-submitted observations<br/>
                            <br/>
                            <strong>Weather Data:</strong><br/>
                            ‚Ä¢ <a href="https://weather.gc.ca/forecast/canada/index_e.html?id=AB" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>Environment Canada</a> - Official forecasts & warnings<br/>
                            ‚Ä¢ <a href="https://www.mountain-forecast.com" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>Mountain-Forecast.com</a> - Peak-specific forecasts<br/>
                            ‚Ä¢ <a href="https://spotwx.com" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>SpotWX</a> - High-resolution weather models & station data<br/>
                            ‚Ä¢ <a href="https://www.wcc.nrcs.usda.gov/snow/" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>SNOTEL</a> - Automated snow monitoring<br/>
                            ‚Ä¢ <a href="https://weather.gc.ca/warnings/index_e.html" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>Weather Warnings</a> - Active alerts<br/>
                            <br/>
                            <strong>Snow & Hydrology:</strong><br/>
                            ‚Ä¢ <a href="https://rivers.alberta.ca" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>Alberta River Basins</a> - Snow survey data<br/>
                            ‚Ä¢ <a href="https://www2.gov.bc.ca/gov/content/environment/air-land-water/water/water-science-data/water-data-tools/snow-survey-data" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>BC Snow Survey</a> - Manual snow courses<br/>
                            <br/>
                            <strong>Community & Education:</strong><br/>
                            ‚Ä¢ <a href="https://www.avalanche.ca/tutorial" target="_blank" style={{color: darkMode ? '#6eb5ff' : '#2a5298'}}>Avalanche Canada Tutorial</a> - Online training<br/>
                            ‚Ä¢ Local social media groups and forums for real-time updates
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<AvalancheDashboard />, document.getElementById('root'));
    </script>
</body>
</html>